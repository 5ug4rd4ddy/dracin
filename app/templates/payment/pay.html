{% extends "base.html" %}

{% block title %}Payment - #{{ transaction.id }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-slate-900 py-12 flex items-center justify-center px-4">
    <div class="bg-card-dark rounded-2xl shadow-xl w-full max-w-md overflow-hidden border border-slate-700 relative">
        <!-- Decoration -->
        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-primary to-purple-500"></div>

        <div class="p-8 text-center">
            <h1 class="text-2xl font-bold text-white mb-2">Scan to Pay</h1>
            <p class="text-slate-400 text-sm mb-8">Please scan the QR code below to complete your order.</p>

            <!-- QR Code Area -->
            <div class="relative mx-auto w-64 h-64 bg-white rounded-xl flex items-center justify-center mb-8 shadow-inner p-2">
                {% if transaction.qris_content %}
                <div id="qrcode"></div>
                {% else %}
                <div class="text-slate-900 text-center p-4">
                    <p>Failed to generate QRIS.</p>
                </div>
                {% endif %}
            </div>

            <!-- Amount -->
            <div class="mb-8">
                <p class="text-xs font-bold uppercase tracking-wider text-slate-500 mb-1">Total Amount</p>
                <div class="text-3xl font-bold text-white">
                    Rp {{ "{:,.0f}".format(transaction.amount).replace(',', '.') }}
                </div>
            </div>

            <!-- Instructions -->
            <div class="bg-slate-800 rounded-xl p-4 text-left text-sm text-slate-400 space-y-3 border border-slate-700">
                <div class="flex gap-3">
                    <div class="flex-shrink-0 w-6 h-6 rounded-full bg-slate-700 flex items-center justify-center font-bold text-xs text-white">1</div>
                    <p>Open your favorite payment app (GoPay, OVO, Dana, BCA, etc).</p>
                </div>
                <div class="flex gap-3">
                    <div class="flex-shrink-0 w-6 h-6 rounded-full bg-slate-700 flex items-center justify-center font-bold text-xs text-white">2</div>
                    <p>Scan the QRIS code above.</p>
                </div>
            </div>
        </div>

        <!-- Sticky Status Footer -->
        <div class="bg-slate-800 p-4 text-center border-t border-slate-700">
            <div id="status-container" class="flex items-center justify-center gap-3 text-slate-300">
                <div class="animate-spin rounded-full h-4 w-4 border-2 border-primary border-t-transparent"></div>
                <span class="font-medium animate-pulse text-sm">Waiting for payment...</span>
            </div>
            <div id="success-container" class="hidden flex items-center justify-center gap-2 text-green-400">
                <span class="material-symbols-outlined">check_circle</span>
                <span class="font-bold">Payment Successful!</span>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
    {% if transaction.qris_content %}
    try {
        new QRCode(document.getElementById("qrcode"), {
            text: "{{ transaction.qris_content }}",
            width: 240,
            height: 240,
            correctLevel: QRCode.CorrectLevel.L
        });
    } catch (e) {
        console.error("QR Gen Error:", e);
    }
    {% endif %}

    const transactionId = "{{ transaction.id }}";
    const statusContainer = document.getElementById('status-container');
    const successContainer = document.getElementById('success-container');
    let pollingInterval;

    function checkStatus() {
        fetch(`/payment/check_status/${transactionId}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'paid') {
                    clearInterval(pollingInterval);
                    statusContainer.classList.add('hidden');
                    successContainer.classList.remove('hidden');
                    setTimeout(() => {
                        window.location.href = "{{ url_for('main.profile') }}";
                    }, 2000);
                }
            })
            .catch(error => console.error('Error polling status:', error));
    }

    // Poll every 3 seconds
    pollingInterval = setInterval(checkStatus, 3000);

    // Initial check
    checkStatus();
</script>
{% endblock %}
